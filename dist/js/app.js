(()=>{"use strict";class e{constructor(e){let t=this;this.cont=document.querySelector("#intro_screen");let n=this.cont.querySelector("label"),o=this.cont.querySelector("button");o.style.display="none",o.addEventListener("click",(function(e){document.dispatchEvent(new CustomEvent("invoke_screen",{detail:{cur_screen:t}}))})),document.addEventListener("main_screen_loading",(function(e){n.textContent=String(Math.round(e.detail.loaded/e.detail.total*100))+"%"})),document.addEventListener("main_screen_ready",(function(e){n.style.display="none",o.style.display=""}))}}class t{constructor(e,t,n,o,i){let s;i=i||[];let a=!1,c=!1,r=!1,d=!1,l=!1,p=performance.now();const u=new THREE.Vector3,h=new THREE.Vector3;let w,y,E,m,g=n.position.z;this.active=!1,s=new THREE.Raycaster(new THREE.Vector3,new THREE.Vector3(0,-1,0),0,10),this.controls=new THREE.PointerLockControls(n,o),this.controls.pointerSpeed=.3;let f=e.querySelector(".joystick_buttons_cont");function _(e){switch(e.code){case"ArrowUp":case"KeyW":a=!0;break;case"ArrowLeft":case"KeyA":r=!0;break;case"ArrowDown":case"KeyS":c=!0;break;case"ArrowRight":case"KeyD":d=!0;break;case"Space":!0===l&&(u.z+=50),l=!1}}function T(e){switch(e.code){case"ArrowUp":case"KeyW":a=!1;break;case"ArrowLeft":case"KeyA":r=!1;break;case"ArrowDown":case"KeyS":c=!1;break;case"ArrowRight":case"KeyD":d=!1}}function v(e){let t=e.target;"pointerdown"==e.type?t==w?r=!0:t==y?d=!0:t==E?a=!0:t==m&&(c=!0):(r=!1,d=!1,a=!1,c=!1)}window.matchMedia("(any-pointer:coarse)").matches?(w=f.querySelector(".joystick_button_left"),y=f.querySelector(".joystick_button_right"),E=f.querySelector(".joystick_button_forward"),m=f.querySelector(".joystick_button_backward"),f.addEventListener("pointerdown",v),f.addEventListener("pointerup",v)):f.remove(),this.activate=function(){this.active=!0,this.controls.isLocked=!0,this.controls.lock(),this.controls.connect(),document.addEventListener("keydown",_),document.addEventListener("keyup",T)},this.deactivate=function(){this.active=!1,a=!1,c=!1,r=!1,d=!1,u.x=0,u.y=0,u.z=0,this.controls.isLocked=!1,this.controls.unlock(),this.controls.disconnect(),document.removeEventListener("keydown",_),document.removeEventListener("keyup",T)},this.addObject=function(e){i.push(e)},this.update=function(){if(this.active){const e=performance.now();s.ray.origin.copy(this.controls.getObject().position),s.ray.origin.z-=10;const t=s.intersectObjects(i,!1).length>0,n=(e-p)/1e3;u.x-=10*u.x*n,u.y-=10*u.y*n,u.z-=196*n,h.x=Number(d)-Number(r),h.y=Number(a)-Number(c),h.normalize(),(a||c)&&(u.y-=200*h.y*n),(r||d)&&(u.x-=200*h.x*n),!0===t&&(u.z=Math.max(0,u.z),l=!0),this.controls.moveRight(-u.x*n),this.controls.moveForward(-u.y*n),this.controls.getObject().position.z+=u.z*n,this.controls.getObject().position.z<g&&(u.z=0,this.controls.getObject().position.z=g,l=!0),p=e}}}}class n{constructor(e,t,n){this.active=!1,this.controls=new THREE.OrbitControls(e,t),this.controls.enableDamping=!0,this.controls.rotateSpeed=.1,this.controls.enablePan=!1,this.activate=function(){this.active=!0,this.controls.active=!0,this.controls.activate()},this.deactivate=function(){this.active=!1,this.controls.active=!1,this.controls.deactivate()},this.update=function(){this.active&&this.controls.update()}}}class o{constructor(e){let o,i,s,a,c,r,d,l,p,u,h,w,y,E,m,g,f,_,T,v,R,b=this,H=[],S=new THREE.Vector3,k=new THREE.Vector2;this.cont=document.querySelector("#main_screen"),f=1,v=new ShaderFrogRuntime,R=new THREE.Clock;let z=this.cont.querySelector(".play_button"),L=this.cont.querySelector(".pause_button"),x=this.cont.querySelector(".outro_screen_button"),M=this.cont.querySelector(".lobby_screen_button"),j=this.cont.querySelector(".toggle_fullscreen_screen_button");function C(t){e.play(t instanceof Event?void 0:t),z.style.display="none",L.style.display=""}function O(e,t){m.loaded[t]=e.loaded,m.total[t]=e.total;let n=0,o=0;m.loaded.forEach((e=>n+=e)),m.total.forEach((e=>o+=e)),document.dispatchEvent(new CustomEvent("main_screen_loading",{detail:{loaded:n,total:o}}))}function q(){v.updateShaders(R.getElapsedTime()),l.render(o,i)}function W(e,t){e.rotation[t]+=.002}function A(e){if(1==f){k.x=e.offsetX/e.target.clientWidth*2-1,k.y=-e.offsetY/e.target.clientHeight*2+1,_.setFromCamera(k,i);let t=_.intersectObjects(H);0!=t.length&&(g=t[0].object,"Group"==g.parent.type&&(g=g.parent),V(g))}}function V(e){f=2,T=!0,C(e.audio_id);for(let t=0;t<H.length;t++)H[t]!=e&&(H[t].visible=!1,H[t].sphere.visible=!1);e.visible=!0,e.sphere.visible=!0,P(!1),c=r,new window.TinyTween({target:e.position,from:Object.assign({},e.position),to:{x:S.x,y:S.y,z:e.position.z},duration:1e3,ease:"easeOutCubic"}),new window.TinyTween({target:e.sphere.position,from:Object.assign({},e.sphere.position),to:{x:S.x,y:S.y,z:e.sphere.position.z},duration:1e3,ease:"easeOutCubic"}),new window.TinyTween({target:i.position,from:Object.assign({},i.position),to:e.focused_camera_position,duration:1e3,ease:"easeOutCubic"}),new window.TinyTween({target:i.rotation,from:{x:i.rotation.x,y:i.rotation.y,z:i.rotation.z},to:e.focused_camera_rotation,duration:1e3,ease:"easeOutCubic",onComplete:()=>P(!0)}),M.style.display=""}function G(e){if(2==f){f=1,T=!0,C(0);for(let e=0;e<H.length;e++)H[e].visible=!0,H[e].sphere.visible=!0;P(!1),c=d,new window.TinyTween({target:g.position,from:Object.assign({},g.position),to:g.def_position,duration:1e3,ease:"easeOutCubic"}),new window.TinyTween({target:g.sphere.position,from:Object.assign({},g.sphere.position),to:g.def_position,duration:1e3,ease:"easeOutCubic"}),new window.TinyTween({target:i.position,from:Object.assign({},i.position),to:s,duration:1e3,ease:"easeOutCubic"}),new window.TinyTween({target:i.rotation,from:{x:i.rotation.x,y:i.rotation.y,z:i.rotation.z},to:a,duration:1e3,ease:"easeOutCubic",onComplete:()=>P(!0)}),M.style.display="none"}else C(0)}function P(e){e?(T=!1,c.activate(),c==r&&r.controls.target.copy(g.focused_camera_target_position),l.domElement.style.pointerEvents=""):(c.deactivate(),l.domElement.style.pointerEvents="none")}window.matchMedia("(any-pointer:coarse)").matches?j.remove():j.addEventListener("click",(function(e){document.dispatchEvent(new CustomEvent("toggle_fullscreen"))})),M.style.display="none",o=new THREE.Scene,i=new THREE.PerspectiveCamera(30,window.innerWidth/window.innerHeight,.1,1e3),o.add(i),v.registerCamera(i),s=new THREE.Vector3(0,-38.5053964150492,3.4281463943465633),a=new THREE.Vector3(1.5389960091929478,-.02672234416349403,0),i.position.copy(s),i.rotation.set(a.x,a.y,a.z),i.up=new THREE.Vector3(0,0,1),l=new THREE.WebGLRenderer({canvas:b.cont.querySelector("#main_screen_canvas"),antialias:!0}),l.shadowMap.enabled=!0,l.shadowMap.type=THREE.PCFSoftShadowMap,l.outputEncoding=THREE.sRGBEncoding,l.setSize(window.innerWidth,window.innerHeight),_=new THREE.Raycaster(new THREE.Vector3,new THREE.Vector3(0,1,0),0),window.addEventListener("resize",(function(e){i.aspect=b.cont.clientWidth/b.cont.clientHeight,i.updateProjectionMatrix(),l.setSize(b.cont.clientWidth,b.cont.clientHeight),q()})),window.addEventListener("keydown",(function(e){"c"==e.key.toLowerCase()&&(console.log("camera.position.set("+i.position.x+", "+i.position.y+", "+i.position.z+");\ncamera.rotation.set("+i.rotation.x+", "+i.rotation.y+", "+i.rotation.z+");"),console.log(c.controls.target))})),function(){let e=new THREE.SpotLight(16777215,1);e.position.set(-5,2,1),e.angle=Math.PI/2,e.penumbra=.3,e.decay=1,e.distance=70,e.castShadow=!0,e.shadow.mapSize.width=512,e.shadow.mapSize.height=512,e.shadow.camera.near=.5,e.shadow.camera.far=500,e.shadow.focus=10,o.add(e);let t=new THREE.SpotLight(16777215,e.intensity);t.position.set(-1*e.position.x,e.position.y,e.position.z),t.angle=e.angle,t.penumbra=e.penumbra,t.decay=e.decay,t.distance=e.distance,t.castShadow=e.castShadow,t.shadow.mapSize.width=e.shadow.mapSize.width,t.shadow.mapSize.height=e.shadow.mapSize.height,t.shadow.camera.near=e.shadow.camera.near,t.shadow.camera.far=e.shadow.camera.far,t.shadow.focus=e.shadow.focus,o.add(t);let n=new THREE.SpotLight(16777215,1);n.position.set(0,-3,3),n.angle=Math.PI/2,n.penumbra=e.penumbra,n.decay=e.decay,n.distance=e.distance,n.castShadow=e.castShadow,n.shadow.mapSize.width=e.shadow.mapSize.width,n.shadow.mapSize.height=e.shadow.mapSize.height,n.shadow.camera.near=e.shadow.camera.near,n.shadow.camera.far=e.shadow.camera.far,n.shadow.focus=e.shadow.focus,o.add(n)}(),d=new t(b.cont,o,i,l.domElement),r=new n(i,l.domElement),function(){let e=new THREE.MeshStandardMaterial({roughness:.6,wireframe:!0,side:THREE.DoubleSide}),t=new THREE.MeshBasicMaterial({color:16711935}),n=new THREE.MeshStandardMaterial({color:5592405,roughness:.6,wireframe:!0,side:THREE.DoubleSide}),i=new THREE.MeshStandardMaterial,s=new THREE.MeshPhysicalMaterial({color:16777215,emissive:0,reflectivity:1,roughness:0,metalness:.93,clearcoat:1,side:THREE.DoubleSide,opacity:.54,transparent:!0,alphaTest:.06,depthTest:!0,depthWrite:!0}),a=new THREE.MeshPhysicalMaterial({color:16777215,emissive:0,reflectivity:1,roughness:0,metalness:.93,clearcoat:1,side:THREE.DoubleSide,opacity:.54,transparent:!0,alphaTest:.06,depthTest:!0,depthWrite:!0});p=new THREE.Mesh(new THREE.PlaneGeometry(1e4,1e4,100,100),i),p.position.z=-3,o.add(p),y=new THREE.Mesh(new THREE.SphereGeometry(13,48,32),s),o.add(y),E=new THREE.Mesh(new THREE.SphereGeometry(16,48,32),a),o.add(E),d.addObject(p);const r=new THREE.OBJLoader,g=new THREE.TextureLoader;m={loaded:[],total:[]},Promise.all([r.loadAsync("assets/models/head/head.obj",(e=>O(e,0))),r.loadAsync("assets/models/angkor/angkor.obj",(e=>O(e,1))),g.loadAsync("assets/models/head/diffuse_texture.jpg",(e=>O(e,2))),g.loadAsync("assets/models/ground/Ground_Wet_Rocks_002_basecolor.jpg",(e=>O(e,3))),g.loadAsync("assets/models/ground/Ground_Wet_Rocks_002_normal.jpg",(e=>O(e,4))),g.loadAsync("assets/models/ground/Ground_Wet_Rocks_002_ambientOcclusion.jpg",(e=>O(e,5))),g.loadAsync("assets/models/ground/Ground_Wet_Rocks_002_roughness.jpg",(e=>O(e,6)))]).then((s=>{u=new THREE.Group,u.audio_id=1,u.sphere=y;let a=s[0].children[0],r=s[2];r.encoding=THREE.sRGBEncoding,e.map=r,e.map.wrapS=THREE.RepeatWrapping,a.material=e,a.rotation.x=Math.PI/2,a.rotation.y=Math.PI/12,a.position.x=.2,a.position.y=2,a.position.z=-2,u.add(a),h=a.clone(),h.material=t,h.position.y=a.position.y+.1,u.position.x=-15,u.add(h),u.def_position=Object.assign({},u.position),u.focused_camera_position=new THREE.Vector3(.04705484996556114,-12.029173746239294,2.9327926975777796),u.focused_camera_target_position=new THREE.Vector3(.035851377656731305,.1501386785179129,.6152351887047028),u.focused_camera_rotation=new THREE.Vector3(1.382757974157833,.0009036621532022624,.0001719545923384852),H.push(u),o.add(u),w=s[1].children[0],w.audio_id=2,w.sphere=E,w.material=n,w.scale.set(.4,.4,.4),w.rotation.x=Math.PI/2,w.position.x=7,w.position.z-=2,w.def_position=Object.assign({},w.position),w.focused_camera_position=new THREE.Vector3(.7791987417913152,-15.488949278591264,.3085232806045406),w.focused_camera_target_position=new THREE.Vector3(-.021439581666074948,.08728617318824601,-.5162077414217627),w.focused_camera_rotation=new THREE.Vector3(1.517897690994109,.05128436397810096,.0027142093736801302),H.push(w),o.add(w),r=s[3],r.encoding=THREE.sRGBEncoding,r.wrapS=THREE.RepeatWrapping,r.wrapT=THREE.RepeatWrapping,r.repeat.set(1e3,1e3),i.map=r;let p=s[4];p.encoding=THREE.sRGBEncoding,p.wrapS=THREE.RepeatWrapping,p.wrapT=THREE.RepeatWrapping,p.repeat.copy(r.repeat),i.normalMap=p;let m=s[5];m.encoding=THREE.sRGBEncoding,m.wrapS=THREE.RepeatWrapping,m.wrapT=THREE.RepeatWrapping,m.repeat.copy(r.repeat),i.aoMap=m;let g=s[6];g.encoding=THREE.sRGBEncoding,g.wrapS=THREE.RepeatWrapping,g.wrapT=THREE.RepeatWrapping,g.repeat.copy(r.repeat),i.roughnessMap=g,i.needsUpdate=!0,y.position.copy(u.position),E.position.copy(w.position),v.load("assets/shaders/sphere1.json",(function(e){y.material=v.get(e.name),E.material=v.get(e.name)})),c=d,q(),document.dispatchEvent(new CustomEvent("main_screen_ready")),document.addEventListener("audio_ended",G),l.domElement.addEventListener("click",A)}))}(),function t(){c&&(c.update(),c!=d||1!=f||T||function(){let e;for(let t=0;t<H.length;t++)if(e=H[t],i.position.distanceTo(e.sphere.position)<1.5*e.sphere.geometry.parameters.radius){g=e,V(g);break}}()),u&&e.is_playing&&(W(u,"z"),W(w,"y")),q(),window.requestAnimationFrame(t)}(),z.addEventListener("click",C),L.addEventListener("click",(function(t){e.pause(),L.style.display="none",z.style.display=""})),x.addEventListener("click",(function(e){document.dispatchEvent(new CustomEvent("invoke_screen",{detail:{cur_screen:b}}))})),M.addEventListener("click",G),this.activate=function(){C(0),c.activate()},this.setup=function(){e.is_playing?(z.style.display="none",L.style.display=""):(L.style.display="none",z.style.display="")}}}class i{constructor(e){let t=this;this.cont=document.querySelector("#outro_screen");let n=this.cont.querySelector(".play_button"),o=this.cont.querySelector(".pause_button"),i=this.cont.querySelector(".main_screen_button"),s=this.cont.querySelector(".toggle_fullscreen_screen_button");window.matchMedia("(any-pointer:coarse)").matches?s.remove():s.addEventListener("click",(function(e){document.dispatchEvent(new CustomEvent("toggle_fullscreen"))})),n.addEventListener("click",(function(t){e.play(),n.style.display="none",o.style.display=""})),o.addEventListener("click",(function(t){e.pause(),o.style.display="none",n.style.display=""})),i.addEventListener("click",(function(e){document.dispatchEvent(new CustomEvent("invoke_screen",{detail:{cur_screen:t}}))})),this.setup=function(){e.is_playing?(n.style.display="none",o.style.display=""):(o.style.display="none",n.style.display="")}}}class s{constructor(e,t){let n=t,o=t,i=document.querySelector("#screen_hider");function s(){n.cont.style.display="none",o.cont.style.display="",new window.TinyTween({target:i.style,from:{opacity:1},to:{opacity:0},duration:300,ease:"easeOutCubic",onComplete:a})}function a(){i.style.display="none"}e.forEach((e=>{e!=t&&(e.cont.style.display="none")})),this.init=function(){s()},this.open=function(e){n=o,o=e,i.style.display="",new window.TinyTween({target:i.style,from:{opacity:0},to:{opacity:1},duration:300,ease:"easeOutCubic",onComplete:s})}}}class a{constructor(e){this.is_playing=!1;let t=document.createElement("audio");t.addEventListener("ended",(function(e){document.dispatchEvent(new CustomEvent("audio_ended"))})),this.play=function(n){void 0!==n&&(isNaN(n)?t.src=n:t.src=e[n]),t.play(),this.is_playing=!0},this.pause=function(){t.pause(),this.is_playing=!1}}}new class{constructor(){let t,n,c,r,d;function l(h){d=new a(["assets/audio/gong_01.mp3","assets/audio/bb-chap1-web.mp3","assets/audio/bb-chap2-web.mp3"]),n=new e(d),t=new o(d),c=new i(d),r=new s([n,t,c],n),window.setTimeout((()=>r.init()),500),document.addEventListener("invoke_screen",p),document.addEventListener("toggle_fullscreen",u),window.removeEventListener("load",l)}function p(e){let o=e.detail.cur_screen;o==n?(t.activate(),r.open(t)):o==t?(c.setup(),r.open(c)):o==c&&(t.setup(),r.open(t))}function u(e){document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()}"complete"==document.readyState?l():window.addEventListener("load",l)}}})();